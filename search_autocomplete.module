<?php

use Drupal\Core\Entity\Element\EntityAutocomplete;
use Drupal\views\Views;
use Drupal\Component\Utility\UrlHelper;
use Drupal\Core\Url;
use Drupal\Core\Utility\UnroutedUrlAssembler;
/**
 * @file
 * Provides autocompletion in any field from GUI.
 *
 * The Search Autocomplete module provides autocompletion configurations
 * to help autocompleting any fields.
 */

/**
 * Implements hook_page_attachments().
 *
 * Adds the settings from user defined autocomplete_configurations to the page.
 * Also loads the necessary JS library if needed.
 */
function search_autocomplete_page_attachments(array &$attachments) {
  // Check user permissions.
  if (!\Drupal::currentUser()->hasPermission('use search autocomplete')) {
    return;
  }

  // Load module settings.
  $module_settings = \Drupal::config('search_autocomplete.settings');

  // TODO Load only configs where a selector is defined.
  $autocomplete_configuration_entities = \Drupal::entityManager()->getStorage('autocompletion_configuration')->loadByProperties(array('status' => TRUE));

  // End-up here if no config to set.
  if (empty($autocomplete_configuration_entities)) {
    return;
  }

  // Add the autocompletion library.
  // @todo define and add properly the library here
  //$page ['#attached']['library'][] = 'quickedit/quickedit';

  // Add the settings to be pass to JS:
  $autocomplete_configurations = array();
  foreach ($autocomplete_configuration_entities as $config_id => $config) {

    $source = $config->getSource();
    $exposed_filters = array();

    // Build the callback URL.
    $input_source = explode('::', $source);
    // If from View, build view URL.
    if (count($input_source) == 2) {
      // Load the view.
      $view = Views::getView($input_source[0]);
      // Load the required display.
      if ($view != null && $view->setDisplay($input_source[1])) {
        // Retrieve the display URL.
        $display = $view->getDisplay();
        $source = '/' . $display->getPath();
      }

      // Build filters
      $filters = $view->getHandlers('filter');
      foreach ($filters as $filter) {
        if ($filter['exposed']) {
          $exposed_filters[] = $filter['field'];
        }
      }
    }

    // In case of internal URL, convert it to absolute.
    if (!UrlHelper::isExternal($source)) {
      $source = Url::fromUri('user-path:' . $source, array('absolute' => TRUE))->toString();
    }

    // Do not add configs when selector is empty.
    // @see todo upper in the fonction.
    if (!empty($config->getSelector())) {
      $settings = array(
        'source'          => $source,
        'selector'        => $config->getSelector(),
        'minChars'        => $config->getMinChar(),
        'maxSuggestions'  => $config->getMaxSuggestions(),
        'theme'           => $config->getTheme(),
        'autoSubmit'      => $config->getAutoSubmit(),
        'autoRedirect'    => $config->getAutoRedirect(),
        'filters'         => $exposed_filters,
      );
      $autocomplete_configurations[$config_id] = $settings;
    }
  }
  //$view = \Drupal::entityManager()->getStorage('view')->load(EntityAutocomplete::extractEntityIdFromAutocompleteInput($config->getSource()));

  $attachments['#attached']['drupalSettings']['search_autocomplete'] = $autocomplete_configurations;
}